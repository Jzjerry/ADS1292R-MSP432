/*
 * Fliter.c
 *
 *  Created on: 2020Äê10ÔÂ2ÈÕ
 *      Author: Jzjerry
 */

#include "Fliter.h"

/* Global Variables */

const int LENGTH = 64;
/*
const float32_t FIR_CoffArray[64] = {
  -0.001387581113, 0.003459413303, 0.007736497093,  0.01030727103,  0.01037941873,
   0.007730200887,  0.00280758366,-0.003327071201,-0.009212699719, -0.01331851631,
   -0.01441918314, -0.01192791108,-0.006103678606, 0.001927779871,  0.01036039367,
    0.01707590371,  0.02012399584,  0.01821358502,  0.01110421401,-0.0001993334008,
   -0.01350942533, -0.02578292973, -0.03366438672,  -0.0341463089, -0.02521691658,
  -0.006360886153,  0.02119792439,  0.05457502976,  0.08962567151,    0.121602647,
     0.1459534913,   0.1591083556,   0.1591083556,   0.1459534913,    0.121602647,
    0.08962567151,  0.05457502976,  0.02119792439,-0.006360886153, -0.02521691658,
    -0.0341463089, -0.03366438672, -0.02578292973, -0.01350942533,-0.0001993334008,
    0.01110421401,  0.01821358502,  0.02012399584,  0.01707590371,  0.01036039367,
   0.001927779871,-0.006103678606, -0.01192791108, -0.01441918314, -0.01331851631,
  -0.009212699719,-0.003327071201,  0.00280758366, 0.007730200887,  0.01037941873,
    0.01030727103, 0.007736497093, 0.003459413303,-0.001387581113
};
*/

//25Hz
const float32_t FIR_CoffArray[64] = {
  -0.004104141612, -0.00146626716,  0.00152169459, 0.004587732721, 0.007431396749,
   0.009750305675,  0.01126863994,  0.01176515874,  0.01109821443, 0.009225351736,
   0.006215463858, 0.002252025297, -0.00237337756,-0.007277184632, -0.01200880948,
   -0.01608273946, -0.01901546679, -0.02036442608, -0.01976581477,  -0.0169682093,
   -0.01185904071,-0.004481564742, 0.004959383048,  0.01610369235,  0.02845422179,
    0.04140593112,   0.0542838946,  0.06638756394,  0.07703791559,  0.08562408388,
    0.09164580703,  0.09474855661,  0.09474855661,  0.09164580703,  0.08562408388,
    0.07703791559,  0.06638756394,   0.0542838946,  0.04140593112,  0.02845422179,
    0.01610369235, 0.004959383048,-0.004481564742, -0.01185904071,  -0.0169682093,
   -0.01976581477, -0.02036442608, -0.01901546679, -0.01608273946, -0.01200880948,
  -0.007277184632, -0.00237337756, 0.002252025297, 0.006215463858, 0.009225351736,
    0.01109821443,  0.01176515874,  0.01126863994, 0.009750305675, 0.007431396749,
   0.004587732721,  0.00152169459, -0.00146626716,-0.004104141612
};

/*
const float32_t FIR_CoffArray[64] = {
   0.008465494029,  0.00910151843, 0.007662582677, 0.004294027574,-0.0004412711714,
  -0.005647985265, -0.01025816333,  -0.0132387802, -0.01380854007, -0.01162098628,
  -0.006874643266,-0.0003225298133, 0.006828852929,  0.01312017441,  0.01710868068,
    0.01766011491,  0.01420943253, 0.006938696839,-0.003167519812, -0.01440895908,
   -0.02459380962, -0.03137014434, -0.03261371702, -0.02680839039, -0.01335342694,
   0.007258704863,  0.03343056515,  0.06262387335,   0.0916800648,   0.1172509193,
     0.1362735033,   0.1464147568,   0.1464147568,   0.1362735033,   0.1172509193,
     0.0916800648,  0.06262387335,  0.03343056515, 0.007258704863, -0.01335342694,
   -0.02680839039, -0.03261371702, -0.03137014434, -0.02459380962, -0.01440895908,
  -0.003167519812, 0.006938696839,  0.01420943253,  0.01766011491,  0.01710868068,
    0.01312017441, 0.006828852929,-0.0003225298133,-0.006874643266, -0.01162098628,
   -0.01380854007,  -0.0132387802, -0.01025816333,-0.005647985265,-0.0004412711714,
   0.004294027574, 0.007662582677,  0.00910151843, 0.008465494029
};
*/

static float32_t firStateBuff[FIR_LENGTH+SAMPLE_INPUT_LENGTH-1];
static arm_fir_instance_f32 S_45Hz;


/* Functions */

void Filter_Init( void )
{
    arm_fir_init_f32(&S_45Hz, FIR_LENGTH, (float32_t*)&FIR_CoffArray[0], &firStateBuff[0], SAMPLE_INPUT_LENGTH);
}


void LowPass_Filter( float32_t* input, float32_t *output)
{
    arm_fir_f32(&S_45Hz, input, output, SAMPLE_INPUT_LENGTH);
}


int32_t Slipper_Ave( int32_t data )
{
    static uint8_t win_now = 1;
    static uint8_t win_max = WIN_LENGTH;
    static int32_t win_array[WIN_LENGTH+1];
    static uint8_t ptr = 0;
    int32_t result = 0;

    win_array[ptr] = data;
    int i = 0;
    for(i = 0;i < win_now;i++)
    {
        result += win_array[i];
    }
    result = result/win_now;
    if( win_now < win_max )
    {
        win_now++;
    }
    ptr++;
    if( ptr >= win_max )
    {
        ptr = 0;
    }
    return result;
}
